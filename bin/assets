#!/usr/bin/env node

const sassPlugin = require("esbuild-sass-plugin").sassPlugin;

let watch = process.argv.includes("--watch");
let minify = process.argv.includes("--minify");
let sourcemap = true;
const prod = process.argv.includes("prod");

if (watch) {
  watch = {
    onRebuild(error, result) {
      if (error) console.error("Build failed:", error);
      else console.log("Built");
    },
  };
}

if (prod) {
  watch = false;
  minify = false;
  sourcemap = false;
}

console.log("Building...");
require("esbuild")
  .build({
    bundle: true,
    loader: { ".gif": "file", ".svg": "file" },
    entryPoints: [
      "app/assets/entry_points/application.js",
      "app/assets/entry_points/blog.js",
      "app/assets/entry_points/admin.js",
    ],
    minify,
    outdir: "app/assets/builds",
    plugins: [sassPlugin()],
    sourcemap,
    watch,
  })
  .catch(() => process.exit(1));
